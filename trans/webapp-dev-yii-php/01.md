# 第一章，认识易

Web 开发框架有助于通过立即交付核心基础和管道来快速启动您的应用程序，以快速将您的想法在白板上涂写为功能性的、生产就绪的代码。由于目前 web 应用程序的所有常见功能以及满足这些期望的可用框架选项，没有理由从头开始编写下一个 web 应用程序。现代、灵活和可扩展的框架对于今天的 web 开发人员来说几乎和编程语言本身一样重要。当这两者特别互补时，结果就是一个非常强大的工具包 Java 和 Spring、Ruby 和 Rails、C#和.NET 以及 PHP 和 Yii。

Yii 是创始人薛强的创意，薛强于 2008 年 1 月 1 日开始开发这个开源框架。在此之前，羌族已经开发并维护了普拉多框架多年。从 PRADO 项目中培养出来的多年经验和用户反馈巩固了对更简单、更可扩展、更高效的基于 PHP5 的框架的需求，以满足应用程序开发人员不断增长的需求。2008 年 10 月，Yii 的首个 alpha 版本正式发布，以满足这些需求。与其他基于 PHP 的框架相比，它令人印象深刻的性能指标立即引起了非常积极的关注。2008 年 12 月 3 日，Yii 1.0 正式发布，截至 2012 年 10 月 1 日，最新的量产版升级至 1.1.12。它拥有一支不断壮大的开发团队，并在 PHP 开发人员中日益流行。

名称**Yii**是**Yes 的首字母缩略词，是**，发音为*Yee*或（*ji:*。Yii 是一个用 PHP5 编写的高性能、基于组件的 web 应用程序框架。该名称还代表了最常用于描述它的形容词，如 easy、effective 和 extensible。让我们来看看 YI 的每一个特点，依次轮流。

# 简单

要运行 Yii 1.x 版的 web 应用程序，您只需要核心框架文件和支持 PHP5.1.0 或更高版本的 web 服务器。要使用 Yii 进行开发，您只需要了解 PHP 和面向对象编程。您不需要学习任何新的配置或模板语言。构建一个 Yii应用程序主要涉及编写和维护您自己的定制 PHP 类，其中一些将从核心 Yii 框架组件类扩展而来。

Yii 融合了其他著名 web 编程框架和应用程序中的许多伟大思想和工作。因此，如果您是通过使用其他 web 开发框架来使用 Yii 的，您可能会发现它很熟悉，而且很容易导航。

Yii 还采用了*约定优于*配置的理念，这有助于它的易用性。这意味着 Yii 对用于配置应用程序的几乎所有方面都有合理的默认设置。按照规定的约定，您可以编写更少的代码，花更少的时间开发应用程序。然而，Yii 不会强迫你的手。它允许您自定义其所有默认设置，并使您可以轻松地覆盖所有这些约定。我们将在本章后面和本书中介绍其中的一些默认设置和约定。

# 高效

Yii 是一种高性能、基于组件的框架，可用于开发任何规模的 web 应用程序。它鼓励在 web 编程中最大限度地重用代码，并可以显著加快开发过程。如前所述，如果您坚持 Yii 的内置约定，您可以在很少或没有手动配置的情况下启动并运行应用程序。

Yii 还旨在帮助您进行*干式*开发。**DRY**代表**不要重复自己**，这是敏捷应用程序开发的关键概念。所有 Yii 应用程序均使用**模型视图控制器**（**MVC**架构构建。Yii 通过提供一个地方来保存 MVC 代码的每一部分，从而强化了这种开发模式。这将最大限度地减少重复，并有助于促进代码重用和易于维护。您需要编写的代码越少，将应用程序推向市场所需的时间就越短。维护您的应用程序越容易，它在市场上停留的时间就越长。

当然，该框架不仅使用效率高，而且速度快，性能优化。Yii 从一开始就考虑到了性能优化，其结果是最高效的 PHP 框架之一。因此，Yii 在上面编写的应用程序中增加的任何额外开销都可以忽略不计。

# 可扩展

Yii 经过精心设计，几乎每一段代码都可以扩展和定制，以满足任何项目需求。事实上，很难不利用 Yii 的易扩展性，因为开发 Yii 应用程序的主要活动是扩展核心框架类。如果你想把你的扩展代码变成对其他开发者有用的工具，Yii 提供了易于遵循的步骤和指导方针来帮助你创建这样的第三方扩展。这使您能够为 Yii 不断增长的功能列表做出贡献，并积极参与扩展 Yii 本身。

值得注意的是，这种易用性、卓越的性能和深度的可扩展性并不以牺牲其特性为代价。Yii 具有许多功能，可以帮助您满足当今 web 应用程序的高要求。支持 AJAX 的小部件、RESTful 和 SOAP Web 服务集成、MVC 体系结构的实施、DAO 和关系 ActiveRecord 数据库层、复杂的缓存、基于角色的分层访问控制、主题化、国际化（I18N）和本地化（L10N）只是 Yii 冰山的一角。从 1.1 版开始，核心框架现在打包了一个名为*Zii*的官方扩展库。这些扩展由核心框架团队成员开发和维护，并继续扩展 Yii 的核心功能集。随着大量用户通过编写 Yii 扩展做出了贡献，基于 Yii 的应用程序的总体功能集每天都在增长。Yii 框架网站上可用的、用户贡献的扩展列表可在[上找到 http://www.yiiframework.com/extensions](http://www.yiiframework.com/extensions) 。还有一个*非官方的*大扩展的扩展库，可以在[找到 http://yiiext.github.com/](http://yiiext.github.com/) ，这确实证明了社区的力量和此框架的可扩展性。

# MVC 架构

如前所述，Yii 是一个 MVC 框架，为每一个模型、视图和控制器代码提供了一个明确的目录结构。在开始构建第一个 Yii 应用程序之前，我们需要定义一些关键术语，并了解 Yii 如何实现和实施这个 MVC 体系结构。

## 模型

通常在 MVC 架构中，*模型*负责维护状态，并且应该封装应用于定义此状态的数据的业务规则。Yii 中的模型是框架类`CModel`或其子类的任何实例。模型类通常由数据属性组成，这些数据属性可以有单独的标签（出于显示的目的，对用户友好），并且可以根据模型中定义的一组规则进行验证。构成模型类中属性的数据可以来自数据库表的一行，也可以来自用户输入表单中的字段。

Yii 实现了两种模型，即表单模型（a`CFormModel`类）和活动记录（a`CActiveRecord`类）。它们都来自同一个基类`CModel`。类`CFormModel`表示收集 HTML 表单输入的数据模型。它封装了表单字段验证的所有逻辑，以及可能需要应用于表单字段数据的任何其他业务逻辑。然后，它可以将数据存储在内存中，或者在活动记录模型的帮助下，将数据存储在数据库中。

**活动记录**（**AR**是一种设计模式，用于以面向对象的方式抽象数据库访问。Yii 中的每个 AR 对象都是`CActiveRecord`或其子类的实例，它在数据库表或视图中封装了一行，封装了数据库访问的所有逻辑和细节，并包含了需要应用于该数据的大部分业务逻辑。表行中每列的数据字段值表示为活动记录对象的属性。活动记录将在稍后更详细地描述。

## 视图

通常，*视图*负责呈现用户界面，通常基于模型中的数据。Yii 中的视图是一个 PHP 脚本，它包含与用户界面相关的元素，通常使用 HTML 构建，但也可以包含 PHP 语句。通常，视图中的任何 PHP 语句都是非常简单的条件语句或循环语句，或者引用其他与 Yii UI 相关的元素，如 HTML 帮助器类方法或预构建的小部件。更复杂的逻辑应该从视图中分离出来，并适当地放置在模型中（如果直接处理数据），或者控制器中（对于更一般的业务逻辑）。

## 控制器

*控制器*是我们路由请求的主要控制器，并且负责获取用户输入，与模型交互，并指示视图进行适当的更新和显示。Yii 中的控制器是`CController`的实例或其子类。当控制器运行时，它执行请求的操作，然后与必要的模型交互，并呈现适当的视图。动作最简单的形式是一个控制器类方法，其名称以单词*action*开头。

# 将这些缝合在一起：Yii 请求路由

在 MVC 实现中，web 请求通常具有以下生命周期：

*   浏览器向托管 MVC 应用程序的服务器发送请求
*   调用控制器操作来处理请求
*   控制器与模型交互
*   控制器调用视图
*   视图呈现数据（通常为 HTML）并将其返回到浏览器进行显示

Yii 的 MVC 实现也不例外。在 Yii 应用程序中，来自浏览器的传入请求首先由路由器接收。路由器分析请求，以决定在应用程序中将其发送到何处进行进一步处理。在大多数情况下，路由器在请求传递到的控制器类中标识特定的操作方法。此操作方法将查看传入的请求数据，可能与模型交互，并执行其他所需的业务逻辑。最终，此操作方法将准备响应数据并将其发送到视图。然后，视图将格式化此数据以符合所需的布局和设计，并将其返回给浏览器显示。

## 博客发帖示例

为了让所有这些更有意义，让我们来看一个虚构的示例。让我们假设我们已经使用 Yii 为自己建立了一个新的博客网站`http://yourblog.com`。这个网站就像大多数典型的博客网站一样。主页显示最近发布的博客文章列表。每个博客帖子的名称都是超链接，可以将用户带到显示全文的页面。下图说明了 Yii 如何处理通过单击其中一个假设博客文章链接发送的传入请求：

![Blog posting example](img/9584_01_01.jpg)

该图跟踪用户点击链接发出的请求：`http://yourblog.com/post/show/id/99`

首先，请求被发送到路由器。路由器解析请求，以决定将其发送到何处。URL 的结构是路由器做出决定的关键。默认情况下，Yii 识别以下格式的 URL：

`http://hostname/index.php?r=ControllerID/ActionID`

`r`querystring 变量是指由 Yii 路由器分析的路由。它将解析此路由以确定适当的控制器和操作方法，以进一步处理请求。现在您可能已经立即注意到，上面的示例 URL 不遵循此默认格式。配置应用程序以识别以下格式的 URL 非常简单：

`http://hostname/ControllerID/ActionID`

在本例中，我们将继续使用此简化格式。URL 中的`ControllerID`名称是指控制器的名称。默认情况下，这是控制器类名的第一部分，直到单词`Controller`。例如，如果您的控制器类名是`TestController`，那么`ControllerID`名称将是*测试*。`ActionID`同样指控制器定义的动作名称。如果操作是控制器中定义的简单方法，则该方法将是方法名称中`action`一词后面的任何方法。例如，如果您的动作方法名为`actionCreate()`，则`ActionID`名称为`create`。

### 注

如果省略了`ActionID`，控制器将执行默认操作，按照惯例，这是控制器中名为`actionIndex()`的方法。如果省略了`ControllerID`，应用程序将使用默认控制器。Yii 默认控制器称为`SiteController`。

回到示例，路由器将分析 URL`http://yourblog.com/post/show/id/99`，并将 URL 路径`post`的第一部分作为`ControllerID`，第二部分`show`作为`ActionID`。这将转换为将请求路由到`PostController`类中的`actionShow()`方法。URL 的最后一部分，`id/99`部分是一个*名称/值*查询字符串参数，该参数将在处理过程中对方法可用。在本例中，数字`99`表示所选博客文章的唯一内部 ID。

在我们虚构的博客应用程序中，`actionShow()`方法处理特定博客文章条目的请求。它使用 querystring 变量`id`来确定请求的具体职位。它要求模型检索关于博客文章条目编号 99 的信息。ModelAR 类与数据库交互以检索请求的数据。从模型中检索数据后，我们的控制器通过使其可供视图使用来进一步准备显示数据。然后，视图负责处理数据布局，并向浏览器返回响应以供用户显示。

这种 MVC 架构允许我们将数据表示与数据操作、验证和其他应用程序业务逻辑分离。这使得开发人员在不影响 UI 的情况下更改应用程序的各个方面非常容易，UI 设计人员也可以在不影响模型或业务逻辑的情况下自由地进行更改。这种分离也使得提供同一模型代码的多个表示变得非常容易。例如，您可以使用驱动`http://yourblog.com`HTML 布局的相同模型代码来驱动 RIA 演示、移动应用程序、web 服务或命令行界面。最后，遵循这些集合约定并分离功能将产生一个更易于扩展和维护的应用程序。

Yii 在帮助您实现这种分离方面做了很多工作，而不仅仅是提供一些命名约定和代码放置位置的建议。它有助于处理将所有碎片缝合在一起所需的所有低级“粘合”代码。这使您能够从严格的 MVC 设计的应用程序中获益，而无需花费所有时间自己编写详细信息。让我们来看看这些低级细节。

# 对象关系映射与活动记录

在大多数情况下，我们构建的 web 应用程序将其数据存储在关系数据库中。我们在前面的示例中使用的 blog post 应用程序在数据库表中保存 blog post 内容。但是，web 应用程序需要将保存在持久数据库存储中的数据映射到定义域对象的内存中类属性。**对象关系映射**（**ORM**库提供数据库表到域对象类的这种映射。

处理 ORM 的大部分代码都是关于描述数据库中的字段如何与内存对象中的属性相对应，编写起来既繁琐又重复。幸运的是，Yii 提供了一个活动记录（activerecord，AR）模式形式的 ORM 层，帮助我们摆脱了这种重复和单调。

## 活动记录

如前所述，AR 是一种设计模式，用于以面向对象的方式抽象数据库访问。它将表映射到类，行映射到对象，列映射到类属性。换句话说，活动记录类的每个实例表示数据库表中的一行。然而，AR 类不仅仅是映射到数据库表中的列的一组属性。它还包含应用于该数据的必要业务逻辑。最终的结果是一个类，它定义了关于如何向数据库写入和从数据库读取数据的所有内容。

通过依赖约定并坚持合理的默认值，Yii 的 AR 实现将为开发人员节省大量的时间，而这些时间可能会花在配置上，或者花在编写创建、读取、更新和删除数据所需的冗长重复的 SQL 语句上。它还允许开发人员以面向对象的方式访问存储在数据库中的数据。为了说明这一点，让我们再次以我们虚构的博客为例。下面是一些使用 AR 操作特定博客文章的示例代码，其内部 ID（也用作表的主键）为`99`。它首先使用主键检索发布。然后更改标题并更新数据库以保存更改：

```php
$post=Post::model()->findByPk(99);
$post->title='Some new title';
$post->save();
```

Active Record 完全免除了我们编写任何 SQL 代码或以其他方式处理底层数据库的繁琐工作。

事实上，Yii 中的活动记录甚至比这更重要。它与 Yii 框架的许多其他方面无缝集成。有许多“活动”HTML 帮助器输入表单字段直接绑定到各自的 AR 类属性。通过这种方式，AR 将输入表单字段值直接提取到模型中。它还支持复杂的自动化数据验证，如果验证失败，Yii 视图类可以轻松地向最终用户显示验证错误。我们将在本书中多次重温 AR 并提供具体示例。

# 视图和控制器

视图和控制器是近亲。控制器将数据提供给视图显示，视图生成页面，触发向控制器发送数据的事件。

在 Yii 中，视图文件属于渲染它的控制器类。这样，我们只需在视图脚本中引用`$this`即可访问控制器实例。这个实现确实使视图和控制器非常亲密。

说到 Yii 控制器，的故事远不止调用模型和渲染视图。控制器可以管理服务以提供复杂的请求前处理和后处理，实施基本访问控制规则以限制对某些操作的访问，管理应用程序范围的布局和嵌套布局文件呈现，管理数据分页，以及许多其他幕后服务。再一次，我们要感谢 Yii 没有让我们的手被这些混乱的细节弄脏。

有很多事情要做。探索它所有美的最好方法就是开始使用它。现在，我们已经掌握了一些非常基本的想法和术语，我们完全有能力做到这一点。

# 总结

在本章中，我们从非常高的层次介绍了 Yii PHP Web 应用程序框架。我们还介绍了 Yii 所采用的一些软件设计概念。如果您对最初讨论的抽象本质有点迷茫，请不要担心。一旦我们深入到具体的例子中，这一切都是有意义的。但总而言之，我们具体涵盖了：

*   应用程序开发框架的重要性和实用性
*   什么是 Yii 以及 Yii 的特性使它难以置信地强大和有用
*   MVC 应用体系结构及其在 Yii 中的实现
*   典型的 Yii web 请求生命周期和 URL 结构
*   Yii 中的对象关系映射和活动记录

在下一章中，我们将介绍简单的 Yii 安装过程，并开始构建一个工作应用程序，以更好地说明所有这些想法。